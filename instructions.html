<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>String Art Instructions</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff0000">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .preview {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            display: block;
            border-radius: 4px;
        }
        .instruction-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 4px;
        }
        .step-number {
            font-size: 24px;
            font-weight: bold;
            margin-right: 15px;
            color: #ff0000;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #ff0000;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .progress {
            margin: 20px 0;
            text-align: center;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <img id="preview" class="preview">
        <div class="controls">
            <button id="prevBtn" onclick="previousStep()">
                <span class="material-icons">arrow_back</span>
                Previous
            </button>
            <button id="nextBtn" onclick="nextStep()">
                Next
                <span class="material-icons">arrow_forward</span>
            </button>
        </div>
        <div class="progress">
            Step <span id="currentStep">0</span> of <span id="totalSteps">0</span>
        </div>
        <div id="instructions"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBR5Vm7ESjz0Fv2rqI55dbXDU5Ei65_SN8",
            authDomain: "stringart-18a36.firebaseapp.com",
            projectId: "stringart-18a36",
            storageBucket: "stringart-18a36.appspot.com",
            messagingSenderId: "1027935072494",
            appId: "1:1027935072494:web:c3413a3e140363f85e83ff",
            measurementId: "G-8938S8PCLR",
            databaseURL: "https://stringart-18a36-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentInstructions = {
            currentStep: 0,
            dots: [],
            steps: []
        };

        window.onload = async () => {
            // Get projectId and userId from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');
            const userId = urlParams.get('userId');
            
            if (!projectId || !userId) {
                alert('Missing project information');
                return;
            }

            try {
                // Ensure user is authenticated
                let user = auth.currentUser;
                if (!user) {
                    try {
                        const result = await signInWithPopup(auth, provider);
                        user = result.user;
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        alert('Authentication required to view instructions');
                        return;
                    }
                }

                // Fetch project data from Firebase under the user's path
                const projectRef = ref(db, `users/${userId}/instructions/${projectId}`);
                const snapshot = await get(projectRef);
                const data = snapshot.val();

                if (!data) {
                    alert('Project not found or access denied');
                    return;
                }

                // Initialize the instructions viewer
                currentInstructions.dots = data.dots;
                document.getElementById('preview').src = data.snapshotB64;
                
                // Generate steps from dots array
                currentInstructions.steps = generateSteps(data.dots);
                
                // Update UI
                document.getElementById('totalSteps').textContent = currentInstructions.steps.length;
                updateStepDisplay();
            } catch (error) {
                console.error("Error loading instructions:", error);
                alert('Error loading instructions. Please try again.');
            }
        };

        function generateSteps(dots) {
            const steps = [];
            for (let i = 0; i < dots.length - 1; i++) {
                steps.push({
                    from: dots[i],
                    to: dots[i + 1],
                    stepNumber: i + 1
                });
            }
            return steps;
        }

        window.previousStep = () => {
            if (currentInstructions.currentStep > 0) {
                currentInstructions.currentStep--;
                updateStepDisplay();
            }
        };

        window.nextStep = () => {
            if (currentInstructions.currentStep < currentInstructions.steps.length - 1) {
                currentInstructions.currentStep++;
                updateStepDisplay();
            }
        };

        function updateStepDisplay() {
            const step = currentInstructions.steps[currentInstructions.currentStep];
            document.getElementById('currentStep').textContent = currentInstructions.currentStep + 1;
            
            // Update button states
            document.getElementById('prevBtn').disabled = currentInstructions.currentStep === 0;
            document.getElementById('nextBtn').disabled = currentInstructions.currentStep === currentInstructions.steps.length - 1;
            
            // Update instruction display
            const instructionsDiv = document.getElementById('instructions');
            instructionsDiv.innerHTML = `
                <div class="instruction-step">
                    <div class="step-number">${step.stepNumber}</div>
                    <div>
                        Connect point at (${Math.round(step.from[0] * 100)}%, ${Math.round(step.from[1] * 100)}%)
                        to point at (${Math.round(step.to[0] * 100)}%, ${Math.round(step.to[1] * 100)}%)
                    </div>
                </div>
            `;
        }

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful');
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        }
    </script>
</body>
</html>
